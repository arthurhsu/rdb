<section>
  <h2>Schema Definition JSON Format</h2>
  <p>Database schema can be defined using a single dictionary object. The
  following example demonstrates how to create a database using such object.</p>
  <pre class="example highlight">
    {{include: create-by-json.js}}
  </pre>

  <p>The following WebIDL defines <code>Schema</code> dictionary type.
  <pre class="idl">
    dictionary Schema {
      DOMString name;
      unsigned short version;
      TableSpec[] table;
    };
  </pre>
  <dl class="dictionary-members">
    <dt><code>name</code></dt>
    <dd>Name of the database</dd>
    <dt><code>version</code></dt>
    <dd>(Optional) Version of the database, for reference only</dd>
    <dt><code>table</code></dt>
    <dd>Array of table specifications</dd>
  </dl>

  <section>
    <h2>Table Specifications</h2>
    <p>The following WebIDL defines table specification dictionary type.</p>
    <pre class="idl">
      dictionary TableSpec {
        DOMString name;
        ColumnSpec[] column;
        ConstraintSpec? constraint;
        IndexSpec[]? index;
      };
    </pre>
    <dl class="dictionary-members">
      <dt><code>name</code></dt>
      <dd>Name of the table</dd>
      <dt><code>column</code></dt>
      <dd>Array of column definitions</dd>
      <dt><code>constraint</code></dt>
      <dd>(Optional) Constraint definitions</dd>
      <dt><code>index</code></dt>
      <dd>(Optional) Array of index definitions</dd>
    </dl>

    <p>The following WebIDL defines column definition dictionary type:</p>
    <pre class="idl">
      dictionary ColumnSpec {
        DOMString name;
        ColumnType type;
        boolean? notNull;
      };
    </pre>
    <dl class="dictionary-members">
      <dt><code>name</code></dt>
      <dd>Name of the column</dd>
      <dt><code>type</code></dt>
      <dd>Type of the column</dd>
      <dt><code>notNull</code></dt>
      <dd>(Optional) Not null</dd>
    </dl>
  </section>

  <section>
    <h2>Index Definition</h2>
    <p>The following WebIDL defines index specification dictionary type:</p>
    <pre class="idl">
      typedef (DOMString or DOMString[] or IndexedColumnSpec[]) IndexedColumnDefinition;
      dictionary IndexSpec {
        DOMString name;
        IndexedColumnDefinition column;
        IndexType type = "btree";
        boolean unique = false;
      };
    </pre>
    <dl class="dictionary-members">
      <dt><code>name</code></dt>
      <dd>Name of the index</dd>
      <dt><code>column</code></dt>
      <dd>Indexed column definitions. If provided as
          <code>DOMString</code> or <code>DOMString[]</code>, default sort
          order of <code>asc</code> is used.</dd>
      <dt><code>type</code></dt>
      <dd>(Optional) Type of index, default to <code>btree</code></dd>
      <dt><code>unique</code></dt>
      <dd>(Optional) Keys in index shall be unique or not,
          default to <code>false</code>.</dd>
    </dl>
    <p>Index type allows user to hint the implementation what this index is
    best to be used for. The implementation may or may not construct the index
    using corresponding algorithm. The index type is an enum:</p>
    <dl title="enum IndexType" class="idl">
      <dt>btree</dt><dd>B+ Tree index</dd>
      <dt>hash</dt><dd>Hash index</dd>
    </dl>

    <p>An index can be keyed by one or more columns unless the
    <code>unique</code> is set to true. In that case, an
    <code>ConstraintError</code> will be thrown if user tried to insert/update
    a row with duplicated key.</p>

    <p>The WebIDL below defines indexed column specification.</p>
    <pre class="idl">
      dictionary IndexedColumnSpec {
        DOMString name;
        Order order = "asc";
      };
    </pre>
    <dl class="dictionary-members">
      <dt><code>name</code></dt>
      <dd>Name of the indexed column</dd>
      <dt><code>order</code></dt>
      <dd>(Optional) Sorting order of the column, default to
          <code>asc</code></dd>
    </dl>
    <p>The name specified in the indexed column must exist in the same table
    defining this index, otherwise an <code>InvalidSchemaError</code> will be
    thrown. If the specified column is not indexable, an
    <code>InvalidSchemaError</code> will be thrown.</p>
    <p>If an index definition overlapped with implicit indices created by
    constraints (for example, create an index on the same column of the primary
    key), it will be up to the implementation to determine whether or not to
    create this index.</p>
  </section>

  <section>
    <h2>Constraint Specification</h2>
    <p>The following WebIDL defines constraint specification.</p>
    <pre class="idl">
      typedef (DOMString or DOMString[] or IndexedColumnSpec[] or PrimaryKeySpec) PrimaryKeyDefinition;
      dictionary ConstraintSpec {
        PrimaryKeyDefinition? primaryKey;
        ForeignKeySpec? foreignKey;
        UniqueSpec? unique;
        (DOMString or DOMString[])? notNull;
      };
    </pre>
    <dl class="dictionary-members">
      <dt><code>primaryKey</code></dt>
      <dd>(Optional) Primary key specification</dd>
      <dt><code>foreignKey</code></dt>
      <dd>(Optional) Foreign key definition</dd>
      <dt><code>unique</code></dt>
      <dd>(Optional) Unique index definitions</dd>
      <dt><code>notNull</code></dt>
      <dd>(Optional) Column(s) that are not null</dd>
    </dl>
    <p>The name(s) specified in the notNull must exist in the same table
    defining this constraint, otherwise an <code>InvalidSchemaError</code>
    will be thrown. By default all columns accept null as valid value, unless
    the column is constrainted with notNull.</p>
  </section>

  <section>
    <h2>Unique Index Definition</h2>
    <p>Unique index is a specialized index that disallows duplicated keys.
    Its definition format is the same as index definition. If two or more
    columns are defined as keys, the combination of the columns forms the
    uniqueness.</p>
    <pre class="idl">
      dictionary UniqueSpec {
        DOMString name;
        IndexedColumnDefinition column;
      };
    </pre>
  </section>

  <section>
    <h2>Primary Key Specification</h2>
    <p>Each table can only have one primary key definition. The primary key
    will implicitly create an unique constraint and enforce it. A primary key
    can be specified using normal index specifications, or use the following
    WebIDL.</p>
    <pre class="idl">
      dictionary PrimaryKeySpec {
        DOMString name;
        boolean autoIncrement;
      };
    </pre>
    <dl class="dictionary-members">
      <dt><code>name</code></dt><dd>Column name of the primary key</dd>
      <dt><code>autoIncrement</code></dt><dd>Create auto-increment key</dd>
    </dl>
    <p>When the autoIncrement field is specified, the specified column must be
    of type <code>Number</code>, otherwise an <code>InvalidSchemaError</code>
    will be thrown. An auto-increment key will start from zero. When a new row
    is inserted into the table, the key will increase by one and assigned to
    that row regardless the original key value given to the row.</p>
  </section>

  <section>
    <h2>Foreign Key Specification</h2>
    <p>The following WebIDL defines foreign key specification.</p>
    <pre class="idl">
      dictionary ForeignKeySpec {
        DOMString name;
        DOMString local;
        DOMString remote;
        ForeignKeyAction action = "restrict";
        ForeignKeyTiming timing = "immediate";
      };
    </pre>
    <dl class="dictionary-members">
      <dt><code>name</code></dt>
      <dd>Name of the foreign key</dd>
      <dt><code>local</code></dt>
      <dd>Referring column name</dd>
      <dt><code>remote</code></dt>
      <dd>Referred column canonical name</dd>
      <dt><code>action</code></dt>
      <dd>(Optional) Foreign key action, default: <code>restrict</code></dd>
      <dt><code>timing</code></dt>
      <dd>(Optional) Foreign key timing, default: <code>immediate</code></dd>
    </dl>
    <p>Foreign key actions are enum values as defined in the following:</p>
    <dl title="enum ForeignKeyAction" class="idl">
      <dt>restrict</dt>
      <dd>Any constraint violation results in cancelling the operation that
      violated the constraint.</dd>
      <dt>cascade</dt>
      <dd>Constraint violation results in modifying related tables as necessary
      to maintain data integrity.</dd>
    </dl>
    <p>Foreign key timings are enum values as defined below:</p>
    <dl title="enum ForeignKeyTiming" class="idl">
      <dt>deferrable</dt>
      <dd>The constraint is enforced right before a transaction is committed.
      The constraint can be violated by individual queries during the lifetime
      of the enclosing transaction, without any error being thrown.</dd>
      <dt>immediate</dt>
      <dd>The constraint is enforced during execution of each individual query.
      </dd>
    </dl>
  </section>

</section>
